From 352ecf92c9d926eb1f0f4b701fb1447a271dd7a7 Mon Sep 17 00:00:00 2001
From: river <riverfor@gmail.com>
Date: Fri, 11 May 2018 23:35:22 -0400
Subject: [PATCH] cross-compile

---
 numpy/core/src/multiarray/common.c  | 29 +++++++++++++++++++++++++++++
 numpy/core/src/private/npy_fpmath.h |  2 ++
 numpy/distutils/system_info.py      | 14 ++++++++++----
 numpy/distutils/unixccompiler.py    |  6 ++++++
 4 files changed, 47 insertions(+), 4 deletions(-)

diff --git a/numpy/core/src/multiarray/common.c b/numpy/core/src/multiarray/common.c
index bd566b7..7c7378b 100644
--- a/numpy/core/src/multiarray/common.c
+++ b/numpy/core/src/multiarray/common.c
@@ -890,3 +890,32 @@ _may_have_objects(PyArray_Descr *dtype)
     return (PyDataType_HASFIELDS(base) ||
             PyDataType_FLAGCHK(base, NPY_ITEM_HASOBJECT) );
 }
+
+/// C-runtime patch
+//extern "C"
+//{
+    // used deep inside FreeImage
+    void* lfind( const void * key, const void * base, size_t num, size_t width, int (*fncomparison)(const void *, const void * ) )
+    {
+        char* Ptr = (char*)base;
+
+        for ( size_t i = 0; i != num; i++, Ptr+=width )
+        {
+            if ( fncomparison( key, Ptr ) == 0 ) return Ptr;
+        }
+
+        return NULL;
+    }
+
+    // used in libcompress
+    int fseeko64(FILE *stream, off64_t offset, int whence)
+    {
+        return fseek( stream, offset & 0xFFFFFFFF, whence );
+    }
+
+    // used in libcompress
+    off64_t ftello64(FILE *stream)
+    {
+        return ftell( stream );
+    }
+//} // extern C
diff --git a/numpy/core/src/private/npy_fpmath.h b/numpy/core/src/private/npy_fpmath.h
index 86b9cf3..ce16058 100644
--- a/numpy/core/src/private/npy_fpmath.h
+++ b/numpy/core/src/private/npy_fpmath.h
@@ -7,6 +7,8 @@
 #include "numpy/npy_cpu.h"
 #include "numpy/npy_common.h"
 
+#define HAVE_LDOUBLE_IEEE_DOUBLE_LE
+
 #ifdef NPY_OS_DARWIN
     /* This hardcoded logic is fragile, but universal builds makes it
      * difficult to detect arch-specific features */
diff --git a/numpy/distutils/system_info.py b/numpy/distutils/system_info.py
index 5da1d5a..994ec9e 100644
--- a/numpy/distutils/system_info.py
+++ b/numpy/distutils/system_info.py
@@ -640,9 +640,11 @@ class system_info(object):
                 continue
 
             if d not in ret:
-                ret.append(d)
+                # Hack for QPython cross compile
+                if not d.lower().startswith("/us"):
+                    ret.append(d)
 
-        log.debug('( %s = %s )', key, ':'.join(ret))
+        log.error('( %s = %s )', key, ':'.join(ret))
         return ret
 
     def get_lib_dirs(self, key='library_dirs'):
@@ -1490,7 +1492,8 @@ class lapack_opt_info(system_info):
         if sys.platform == 'darwin' and not atlas_info:
             # Use the system lapack from Accelerate or vecLib under OSX
             args = []
-            link_args = []
+            link_args = ['-lm','-lgcc', '-lc', '-ldl', '-L'+os.environ['ANDROID_NDK']+'/toolchains/renderscript/prebuilt/'+os.uname().sysname.lower()+'-x86_64/platform/arm'] #, '-lcompiler_rt']
+            """
             if get_platform()[-4:] == 'i386' or 'intel' in get_platform() or \
                'x86_64' in get_platform() or \
                'i386' in platform.platform():
@@ -1511,6 +1514,7 @@ class lapack_opt_info(system_info):
                 else:
                     args.extend(['-faltivec'])
                 link_args.extend(['-Wl,-framework', '-Wl,vecLib'])
+            """
             if args:
                 self.set_info(extra_compile_args=args,
                               extra_link_args=link_args,
@@ -1590,7 +1594,8 @@ class blas_opt_info(system_info):
         if sys.platform == 'darwin' and not atlas_info:
             # Use the system BLAS from Accelerate or vecLib under OSX
             args = []
-            link_args = []
+            link_args = ['-lm','-lgcc', '-lc', '-ldl', '-L'+os.environ['ANDROID_NDK']+'/toolchains/renderscript/prebuilt/'+os.uname().sysname.lower()+'-x86_64/platform/arm'] #, '-lcompiler_rt']
+            """
             if get_platform()[-4:] == 'i386' or 'intel' in get_platform() or \
                'x86_64' in get_platform() or \
                'i386' in platform.platform():
@@ -1615,6 +1620,7 @@ class blas_opt_info(system_info):
                 args.extend([
                     '-I/System/Library/Frameworks/vecLib.framework/Headers'])
                 link_args.extend(['-Wl,-framework', '-Wl,vecLib'])
+            """
             if args:
                 self.set_info(extra_compile_args=args,
                               extra_link_args=link_args,
diff --git a/numpy/distutils/unixccompiler.py b/numpy/distutils/unixccompiler.py
index a92ccd3..1001ef8 100644
--- a/numpy/distutils/unixccompiler.py
+++ b/numpy/distutils/unixccompiler.py
@@ -43,6 +43,8 @@ def UnixCCompiler__compile(self, obj, src, ext, cc_args, extra_postargs, pp_opts
         if opt not in llink_s:
             self.linker_so = llink_s.split() + opt.split()
 
+    self.compiler_so[0] = 'arm-linux-androideabi-gcc'
+    self.linker_so[0] = 'arm-linux-androideabi-gcc'
     display = '%s: %s' % (os.path.basename(self.compiler_so[0]), src)
     try:
         self.spawn(self.compiler_so + cc_args + [src, '-o', obj] +
@@ -94,12 +96,15 @@ def UnixCCompiler_create_static_lib(self, objects, output_libname,
             pass
         self.mkpath(os.path.dirname(output_filename))
         tmp_objects = objects + self.objects
+        from os import environ
+        self.archiver[0] = 'arm-linux-androideabi-ar'
         while tmp_objects:
             objects = tmp_objects[:50]
             tmp_objects = tmp_objects[50:]
             display = '%s: adding %d object files to %s' % (
                            os.path.basename(self.archiver[0]),
                            len(objects), output_filename)
+            #log.error(self.archiver)
             self.spawn(self.archiver + [output_filename] + objects,
                        display = display)
 
@@ -109,6 +114,7 @@ def UnixCCompiler_create_static_lib(self, objects, output_libname,
         # needed -- or maybe Python's configure script took care of
         # it for us, hence the check for leading colon.
         if self.ranlib:
+            self.ranlib[0] = 'arm-linux-androideabi-ranlib'
             display = '%s:@ %s' % (os.path.basename(self.ranlib[0]),
                                    output_filename)
             try:
-- 
2.7.4

